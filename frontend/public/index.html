<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Required for Relayer WASM workers -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin"/>
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp"/>
  <title>Hidden Code Quality · Zama FHEVM</title>
  <meta name="description" content="Aggregate-only, blind code quality scoring. Encrypted metrics in, public sum out. Zama FHEVM + Relayer SDK 0.2.0."/>

  <!-- Distinct visual: light clay + editorial grid -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Satoshi:wght@400;700;900&family=Fraunces:opsz,wght@9..144,700;9..144,900&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#f4f6f8; --paper:#ffffff; --ink:#0f172a; --muted:#5b6677; --line:#e6e9ee;
      --tea:#2f9e44; --rose:#e03131; --citrus:#ffb703; --sea:#1971c2; --lav:#845ef7;
      --mono:"JetBrains Mono",ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      --sans:"Satoshi",system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;
      --serif:"Fraunces",Georgia,serif; --r:18px; --shadow:0 18px 50px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#f7f8fb,#f4f6f8);color:var(--ink);font-family:var(--sans)}
    header{position:sticky;top:0;z-index:30;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .bar{max-width:1180px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .seal{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;font:900 13px var(--mono);color:#fff;background:conic-gradient(from 210deg,#1971c2,#845ef7,#2f9e44,#1971c2);box-shadow:inset 0 0 0 1px rgba(255,255,255,.3)}
    .title{margin:0;font:900 22px var(--serif);letter-spacing:.2px}
    .subtitle{margin:0;color:var(--muted);font:700 12px var(--mono)}

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font:700 12px var(--mono);color:#334155;box-shadow:inset 0 2px 0 rgba(255,255,255,.7)}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111827;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-pri{background:linear-gradient(180deg,#1971c2,#184e77);color:#fff;border-color:#1971c2}
    .btn-sec{background:#fff}

    main{max-width:1180px;margin:24px auto 60px;padding:0 18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}

    .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 6px;font:900 18px var(--serif)}
    .note{font:600 12px var(--mono);color:var(--muted)}

    .rows{display:grid;gap:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.two{grid-template-columns:1fr}}

    label{font:800 11px var(--mono);color:#475569;letter-spacing:.06em}
    input{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:#fff;outline:none;font:800 14px var(--sans)}
    input:focus{box-shadow:0 0 0 4px rgba(132,94,247,.15)}

    .status{margin-top:10px;border:1px dashed var(--line);background:#fff;border-radius:14px;padding:12px;min-height:48px;display:flex;align-items:center;justify-content:center;font:700 12px var(--mono);color:#475569}
    .status.ok{border-color:rgba(47,158,68,.35);color:#2f9e44}
    .status.err{border-color:rgba(224,49,49,.35);color:#e03131}

    .handles{font:700 12px var(--mono);color:#0f172a;background:#f8fafc;border:1px dashed var(--line);border-radius:14px;padding:10px;word-break:break-all}

    .list{display:grid;gap:10px}
    .rowcard{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:16px;padding:12px}
    .rowcard h4{margin:0;font:900 15px var(--serif)}

    footer{max-width:1180px;margin:16px auto 40px;padding:0 18px;color:#64748b;font:700 12px var(--mono)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="seal">FHE</div>
        <div>
          <div class="title">Hidden Code Quality</div>
          <div class="subtitle">Aggregate-only · Zama FHEVM · Relayer 0.2.0</div>
        </div>
      </div>
      <div class="row">
        <span id="netChip" class="chip">Network: —</span>
        <span id="addrChip" class="chip">Contract: —</span>
        <button id="btnConnect" class="btn btn-pri">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <section class="grid">
      <!-- Submit metrics & publish sum -->
      <article class="card">
        <h2>Submit Encrypted Metrics</h2>
        <p class="note">coverage/style higher is better; complexity/bugs lower is better. Inputs are encrypted; only the aggregate sum is public.</p>
        <div class="rows">
          <div class="two">
            <div>
              <label>Coverage (0..100)</label>
              <input id="cov" type="number" min="0" max="100" placeholder="82"/>
            </div>
            <div>
              <label>Style (0..100)</label>
              <input id="style" type="number" min="0" max="100" placeholder="76"/>
            </div>
          </div>
          <div class="two">
            <div>
              <label>Complexity (0..100)</label>
              <input id="compl" type="number" min="0" max="100" placeholder="28"/>
            </div>
            <div>
              <label>Bugs (0..100)</label>
              <input id="bugs" type="number" min="0" max="100" placeholder="4"/>
            </div>
          </div>
          <div class="row">
            <button id="btnSubmit" class="btn btn-pri">Submit Metrics (Encrypted)</button>
            <span id="subTx" class="chip">TX: —</span>
          </div>
          <div id="subLog" class="status">Ready</div>
        </div>

        <div style="height:10px"></div>
        <h2>Publish Aggregate</h2>
        <p class="note">Publishes the encrypted <b>sumScore</b> for public decryption. Average is computed off‑chain as <code>sum_dec / submissions</code>.</p>
        <div class="row">
          <button id="btnPublish" class="btn btn-sec">Publish Sum (public)</button>
          <button id="btnDecrypt" class="btn btn-sec">Decrypt Sum</button>
          <span id="avgChip" class="chip">Avg: —</span>
        </div>
        <div id="pubLog" class="status">—</div>
      </article>

      <!-- Policy & aggregates -->
      <article class="card">
        <h2>Policy (Thresholds)</h2>
        <p class="note">All thresholds are encrypted by the owner: <b>cov ≥ min</b>, <b>style ≥ min</b>, <b>compl ≤ max</b>, <b>bugs ≤ max</b>. Each satisfied check adds 25 points.</p>
        <div class="rows">
          <div class="two">
            <div>
              <label>tCovMin (0..100)</label>
              <input id="tCovMin" type="number" min="0" max="100" placeholder="70"/>
            </div>
            <div>
              <label>tStyleMin (0..100)</label>
              <input id="tStyleMin" type="number" min="0" max="100" placeholder="70"/>
            </div>
          </div>
          <div class="two">
            <div>
              <label>tComplMax (0..100)</label>
              <input id="tComplMax" type="number" min="0" max="100" placeholder="35"/>
            </div>
            <div>
              <label>tBugsMax (0..100)</label>
              <input id="tBugsMax" type="number" min="0" max="100" placeholder="10"/>
            </div>
          </div>
          <div class="row">
            <button id="btnSetPolEnc" class="btn btn-pri">Set Encrypted</button>
            <button id="btnMakePolPublic" class="btn btn-sec">Make Policy Public</button>
          </div>
          <div id="polHandles" class="handles">tCovMin: —\ntStyleMin: —\ntComplMax: —\ntBugsMax: —</div>
          <div id="adminLog" class="status">Owner-only actions. Connect wallet.</div>
        </div>

        <div style="height:10px"></div>
        <h2>Aggregates</h2>
        <div class="rows">
          <div id="aggHandles" class="handles">sumScore: —\nsubmissions: —</div>
          <div class="row"><button id="btnRefreshAgg" class="btn btn-sec">Refresh</button></div>
        </div>
      </article>
    </section>
  </main>

  <footer>
    Built for Zama FHEVM • Ethers v6 • Relayer SDK 0.2.0 · Contract: <span id="addrFoot"></span>
  </footer>

  <!-- SDKs (ESM) -->
  <script type="module" crossorigin src="https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js"></script>
  <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"></script>

  <script type="module">
    import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
    import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    // ===== App Config =====
    const CONTRACT_ADDRESS = "0x4A8b95270369De027a34E02b49FFe1D49d97112f"; // deployed
    const RELAYER_URL = "https://relayer.testnet.zama.org";
    const CHAIN_ID_HEX = "0xaa36a7"; // Sepolia

    // ===== ABI (HiddenCodeQualityAggregate v2: no division) =====
    const abi = [
      { inputs: [], name: "version", outputs: [{ type: "string" }], stateMutability: "pure", type: "function" },
      { inputs: [], name: "owner", outputs: [{ type: "address" }], stateMutability: "view", type: "function" },

      { inputs: [ { name: "tCovMinExt", type: "bytes32" }, { name: "tStyleMinExt", type: "bytes32" }, { name: "tComplMaxExt", type: "bytes32" }, { name: "tBugsMaxExt", type: "bytes32" }, { name: "proof", type: "bytes" } ], name: "setPolicyEncrypted", outputs: [], stateMutability: "nonpayable", type: "function" },
      { inputs: [], name: "makePolicyPublic", outputs: [], stateMutability: "nonpayable", type: "function" },
      { inputs: [], name: "getPolicyHandles", outputs: [ { type: "bytes32" }, { type: "bytes32" }, { type: "bytes32" }, { type: "bytes32" } ], stateMutability: "view", type: "function" },

      { inputs: [ { name: "covExt", type: "bytes32" }, { name: "styleExt", type: "bytes32" }, { name: "complExt", type: "bytes32" }, { name: "bugsExt", type: "bytes32" }, { name: "proof", type: "bytes" } ], name: "submitMetrics", outputs: [], stateMutability: "nonpayable", type: "function" },

      { inputs: [], name: "publishSum", outputs: [ { type: "bytes32" } ], stateMutability: "nonpayable", type: "function" },
      { inputs: [], name: "getAggregateHandles", outputs: [ { type: "bytes32" }, { type: "uint16" } ], stateMutability: "view", type: "function" }
    ];

    // ===== Elements =====
    const $ = (id) => document.getElementById(id);
    const els = {
      btnConnect: $("btnConnect"), netChip: $("netChip"), addrChip: $("addrChip"), addrFoot: $("addrFoot"),
      cov: $("cov"), style: $("style"), compl: $("compl"), bugs: $("bugs"), btnSubmit: $("btnSubmit"), subLog: $("subLog"), subTx: $("subTx"),
      btnPublish: $("btnPublish"), btnDecrypt: $("btnDecrypt"), pubLog: $("pubLog"), avgChip: $("avgChip"),
      tCovMin: $("tCovMin"), tStyleMin: $("tStyleMin"), tComplMax: $("tComplMax"), tBugsMax: $("tBugsMax"), btnSetPolEnc: $("btnSetPolEnc"), btnMakePolPublic: $("btnMakePolPublic"), polHandles: $("polHandles"), adminLog: $("adminLog"),
      aggHandles: $("aggHandles"), btnRefreshAgg: $("btnRefreshAgg"),
    };

    els.addrChip.textContent = `Contract: ${CONTRACT_ADDRESS}`;
    els.addrFoot.textContent = CONTRACT_ADDRESS;

    // ===== State =====
    let provider, signer, user, contract, relayer, isOwner=false;
    let lastSumHandle = null; // cache after publish

    const LOG = {
      info:(el, s) => { el.textContent = s; el.className = "status"; console.log("[INFO]", s); },
      ok:(el, s)   => { el.textContent = s; el.className = "status ok"; console.log("[OK]", s); },
      err:(el, s)  => { el.textContent = s; el.className = "status err"; console.error("[ERR]", s); },
    };

    // ===== Bind =====
    els.btnConnect.addEventListener('click', connect);
    els.btnSubmit.addEventListener('click', submitMetrics);
    els.btnPublish.addEventListener('click', publishSum);
    els.btnDecrypt.addEventListener('click', decryptSum);
    els.btnSetPolEnc.addEventListener('click', setPolicyEnc);
    els.btnMakePolPublic.addEventListener('click', makePolicyPublic);
    els.btnRefreshAgg.addEventListener('click', refreshAggregates);

    // ===== Connect =====
    async function connect(){
      try{
        if(!window.ethereum) throw new Error("MetaMask not found");
        provider = new BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        let net = await provider.getNetwork();
        if(net.chainId !== 11155111n){ await provider.send('wallet_switchEthereumChain', [{ chainId: CHAIN_ID_HEX }]); net = await provider.getNetwork(); }
        els.netChip.textContent = `Network: Sepolia (${String(net.chainId)})`;

        signer = await provider.getSigner();
        user = await signer.getAddress();
        els.btnConnect.textContent = `${user.slice(0,6)}…${user.slice(-4)}`;
        els.btnConnect.disabled = true;

        contract = new Contract(CONTRACT_ADDRESS, abi, signer);

        await initSDK();
        relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, network: window.ethereum, debug:true });

        try{ const o = await contract.owner(); isOwner = (o.toLowerCase()===user.toLowerCase()); }catch{}
        els.adminLog.textContent = isOwner ? "Owner detected ✓" : "You are not the owner";
        await showPolicyHandles();
        await refreshAggregates();
      }catch(e){ alert(e.message || String(e)); }
    }

    // ===== Helpers =====
    const in01 = (n)=>{ const x = Number(n); return Number.isFinite(x) && x>=0 && x<=100; };

    async function showPolicyHandles(){
      try{ const [a,b,c,d] = await contract.getPolicyHandles(); els.polHandles.textContent = `tCovMin: ${a}\ntStyleMin: ${b}\ntComplMax: ${c}\ntBugsMax: ${d}`; }catch{}
    }

    async function refreshAggregates(){
      try{ const [sumH, cnt] = await contract.getAggregateHandles(); els.aggHandles.textContent = `sumScore: ${sumH}\nsubmissions: ${cnt}`; }catch(e){ console.error(e); }
    }

    // ===== Admin: Policy =====
    async function setPolicyEnc(){
      try{
        if(!isOwner) throw new Error('Owner only');
        const a = Number(els.tCovMin.value||"0"), b = Number(els.tStyleMin.value||"0"), c = Number(els.tComplMax.value||"0"), d = Number(els.tBugsMax.value||"0");
        if(!in01(a)||!in01(b)||!in01(c)||!in01(d)) throw new Error('0..100 only');
        LOG.info(els.adminLog, 'Encrypting policy…');
        const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
        buf.add16(a); buf.add16(b); buf.add16(c); buf.add16(d);
        const { handles, inputProof } = await buf.encrypt();
        try{ await contract.setPolicyEncrypted.staticCall(handles[0], handles[1], handles[2], handles[3], inputProof); }catch{}
        const tx = await contract.setPolicyEncrypted(handles[0], handles[1], handles[2], handles[3], inputProof);
        els.adminLog.textContent = `TX: ${tx.hash}`;
        await tx.wait();
        LOG.ok(els.adminLog, 'Policy set (encrypted) ✓');
        await showPolicyHandles();
      }catch(e){ LOG.err(els.adminLog, e.message || String(e)); }
    }

    async function makePolicyPublic(){
      try{
        if(!isOwner) throw new Error('Owner only');
        const tx = await contract.makePolicyPublic();
        els.adminLog.textContent = `TX: ${tx.hash}`;
        await tx.wait();
        LOG.ok(els.adminLog, 'Policy marked public ✓');
      }catch(e){ LOG.err(els.adminLog, e.message || String(e)); }
    }

    // ===== Submit metrics =====
    async function submitMetrics(){
      try{
        if(!contract) await connect();
        const cov = Number(els.cov.value||"0"), style = Number(els.style.value||"0"), compl = Number(els.compl.value||"0"), bugs = Number(els.bugs.value||"0");
        if(!in01(cov)||!in01(style)||!in01(compl)||!in01(bugs)) throw new Error('Inputs must be 0..100');
        LOG.info(els.subLog, 'Encrypting metrics…');
        const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
        buf.add16(cov); buf.add16(style); buf.add16(compl); buf.add16(bugs);
        const { handles, inputProof } = await buf.encrypt();
        try{ await contract.submitMetrics.staticCall(handles[0], handles[1], handles[2], handles[3], inputProof); }catch{}
        const tx = await contract.submitMetrics(handles[0], handles[1], handles[2], handles[3], inputProof);
        els.subTx.textContent = `TX: ${tx.hash}`;
        await tx.wait();
        LOG.ok(els.subLog, 'Metrics submitted ✓');
        await refreshAggregates();
      }catch(e){ LOG.err(els.subLog, e.message || String(e)); }
    }

    // ===== Publish & Decrypt sum =====
    async function publishSum(){
      try{
        LOG.info(els.pubLog, 'Publishing sum…');
        const tx = await contract.publishSum();
        els.pubLog.textContent = `TX: ${tx.hash}`;
        await tx.wait();
        const [sumH] = await contract.getAggregateHandles();
        lastSumHandle = sumH;
        LOG.ok(els.pubLog, 'Published ✓  (handle cached)');
        els.avgChip.textContent = 'Avg: — (decrypt first)';
      }catch(e){ LOG.err(els.pubLog, e.message || String(e)); }
    }

    async function decryptSum(){
      try{
        const [sumH, cnt] = await contract.getAggregateHandles();
        const handle = lastSumHandle || sumH;
        if(!handle || handle === '0x0000000000000000000000000000000000000000000000000000000000000000'){
          LOG.info(els.pubLog, 'No published sum yet — click "Publish Sum"');
          return;
        }
        const pairs = [{ handle: String(handle), contractAddress: CONTRACT_ADDRESS }];
        let out;
        try{ out = await relayer.publicDecrypt(pairs); }
        catch(e1){ try{ out = await relayer.publicDecrypt([String(handle)]); } catch(e2){ throw e1; } }
        let v = out[handle] ?? out[String(handle)] ?? (Array.isArray(out)? out[0] : undefined);
        if(v === undefined){ LOG.err(els.pubLog, 'Decrypt failed'); return; }
        const sumDec = Number(v);
        if(cnt === 0){ LOG.info(els.pubLog, 'No submissions'); els.avgChip.textContent = 'Avg: —'; return; }
        const avg = sumDec / Number(cnt);
        els.avgChip.textContent = `Avg: ${avg.toFixed(2)}`;
        LOG.ok(els.pubLog, `Decrypted sum = ${sumDec}, submissions = ${cnt}`);
      }catch(e){ LOG.err(els.pubLog, e.message || String(e)); }
    }
  </script>
</body>
</html>
